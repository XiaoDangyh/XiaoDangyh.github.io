{"title":"STM32F1 timer KEY","slug":"STM32F1-timer-KEY","date":"2021-08-26T03:49:31.000Z","updated":"2021-09-03T14:13:38.490Z","comments":true,"path":"api/articles/STM32F1-timer-KEY.json","photos":[],"link":"","excerpt":"STM32F1定时器实验-外部触发脉冲计数之前我们用外部中断测量了PWM的频率，而外部触发是设置2个定时器，利用按键触发，一个定时器2用来接受外部触发信号并计数，另一个定时器6实时检测按键。","covers":["https://img-blog.csdnimg.cn/1c7af8ac65064314a19f83d273578e06.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_Q1NETiBA5Y2X5bGx56yR,size_165,color_FFFFFF,t_70,g_se,x_16","https://img-blog.csdnimg.cn/c310f614ea674bd7a36bab52fe7556e9.png","https://img-blog.csdnimg.cn/0d925669e44a45d591c29f341f0f0b45.png","https://img-blog.csdnimg.cn/979c22c7e76f4ab78bc893bb547e198b.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_Q1NETiBA5Y2X5bGx56yR,size_40,color_FFFFFF,t_70,g_se,x_16","https://img-blog.csdnimg.cn/e25a54d171e6456e9606191ea4a2796e.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_Q1NETiBA5Y2X5bGx56yR,size_28,color_FFFFFF,t_70,g_se,x_16","https://img-blog.csdnimg.cn/a29154c1ca2a4f3587b8d571a6a4f741.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_Q1NETiBA5Y2X5bGx56yR,size_34,color_FFFFFF,t_70,g_se,x_16"],"content":"<h1 id=\"STM32F1定时器实验-外部触发脉冲计数\"><a href=\"#STM32F1定时器实验-外部触发脉冲计数\" class=\"headerlink\" title=\"STM32F1定时器实验-外部触发脉冲计数\"></a>STM32F1定时器实验-外部触发脉冲计数</h1><iframe frameborder=\"no\" border=\"0\" marginwidth=\"0\" marginheight=\"0\" width=330 height=86 src=\"//music.163.com/outchain/player?type=2&id=31066775&auto=1&height=66\"></iframe>\n\n<p>之前我们用外部中断测量了PWM的频率，而外部触发是设置2个定时器，利用按键触发，一个定时器2用来接受外部触发信号并计数，另一个定时器6实时检测按键。</p>\n<span id=\"more\"></span>\n\n<p>按照这样的思路，我们的按键读取用状态机思想去读取，使定时器6产生10ms的定时中断来实时检测按键并利用状态机设计思想处理按键信号，将PA1设置成输出引脚，设置定时器2的PA0引脚来接收信号，通过按键触发改变标志位来发送电平信号，再定义全局数存放PA0接收脉冲信号次数，最后串口配置。<br>什么？你不知道状态机思想？<a href=\"https://blog.csdn.net/xinghuanmeiying/article/details/81586954?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522162990144516780274127283%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=162990144516780274127283&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-2-81586954.pc_search_similar&utm_term=%E7%8A%B6%E6%80%81%E6%9C%BA%E5%9B%BE&spm=1018.2226.3001.4187\">送你学习状态机</a><br>说实话，状态机思想可以清晰把你的代码逻辑弄清楚，这个是我自己写按键时画的草图：<br><img src=\"https://img-blog.csdnimg.cn/1c7af8ac65064314a19f83d273578e06.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_Q1NETiBA5Y2X5bGx56yR,size_165,color_FFFFFF,t_70,g_se,x_16\" alt=\"在这里插入图片描述\"><br>画的只要你自己可以看懂就行</p>\n<h2 id=\"代码讲解\"><a href=\"#代码讲解\" class=\"headerlink\" title=\"代码讲解\"></a>代码讲解</h2><p>首先我们需要按键的状态，它的状态分为检测，按下，释放，所以定义枚举类型的结构体</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* USER CODE BEGIN PTD */</span></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"keyword\">enum</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tKEY_CHECK=<span class=\"number\">0</span>,</span><br><span class=\"line\">\tKEY_CONFRIM,</span><br><span class=\"line\">\tKEY_RELAESE</span><br><span class=\"line\">&#125;KEY_STATE;</span><br><span class=\"line\"><span class=\"comment\">/* USER CODE END PTD */</span></span><br></pre></td></tr></table></figure>\n<p>状态变量的定义以及标志位，计数值</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* USER CODE BEGIN PV */</span></span><br><span class=\"line\">KEY_STATE  keyState=KEY_CHECK;</span><br><span class=\"line\"><span class=\"type\">int</span> Result=<span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"type\">uint8_t</span> keyvalue=<span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* USER CODE END PV */</span></span><br></pre></td></tr></table></figure>\n<p>对于按键检测，是在TIM6里处理的，选用KEY1即PE3<br><img src=\"https://img-blog.csdnimg.cn/c310f614ea674bd7a36bab52fe7556e9.png\" alt=\"在这里插入图片描述\"></p>\n<p><img src=\"https://img-blog.csdnimg.cn/0d925669e44a45d591c29f341f0f0b45.png\" alt=\"在这里插入图片描述\"></p>\n<p>而之间的状态转移是通过判断电平实现的，按下时为低电平，未按下为高电平，根据我们按下的一个完整过程，我们可以通过switch语句实现我们的整个过程</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* USER CODE BEGIN 4 */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">HAL_TIM_PeriodElapsedCallback</span><span class=\"params\">(TIM_HandleTypeDef *htim)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(htim-&gt;Instance==TIM6)<span class=\"comment\">//判断是否为TIM6中断</span></span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">switch</span>(keyState)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> KEY_CHECK:<span class=\"comment\">//检测状态下</span></span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span>(<span class=\"built_in\">HAL_GPIO_ReadPin</span>(GPIOE,GPIO_PIN_3)==GPIO_PIN_RESET)<span class=\"comment\">//检测按键为低电平</span></span><br><span class=\"line\">\t\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t\tkeyState=KEY_CONFRIM;<span class=\"comment\">//确认按下状态</span></span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> KEY_CONFRIM:<span class=\"comment\">//确认按下状态下</span></span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"built_in\">HAL_GPIO_ReadPin</span>(GPIOE,GPIO_PIN_3)==GPIO_PIN_RESET)<span class=\"comment\">//再次判断\t</span></span><br><span class=\"line\">\t\t\t\t&#123;</span><br><span class=\"line\">              keyvalue=<span class=\"number\">1</span>;<span class=\"comment\">//改变标志位用于触发脉冲信号</span></span><br><span class=\"line\">              keyState=KEY_RELAESE;<span class=\"comment\">//按下后释放</span></span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">         <span class=\"keyword\">else</span>\t\t</span><br><span class=\"line\">\t\t\t\t &#123;</span><br><span class=\"line\">\t\t\t\t\t    keyState=KEY_CHECK;<span class=\"comment\">//排除抖动干扰或者误判，回到检测</span></span><br><span class=\"line\">\t\t\t\t &#125;</span><br><span class=\"line\">\t\t\t\t <span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t &#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> KEY_RELAESE:<span class=\"comment\">//释放状态下</span></span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span>(<span class=\"built_in\">HAL_GPIO_ReadPin</span>(GPIOE,GPIO_PIN_3)==GPIO_PIN_SET)\t<span class=\"comment\">//判断按键未按下</span></span><br><span class=\"line\">\t\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t\tkeyState=KEY_CHECK;<span class=\"comment\">//回到检测状态</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">//\tkeyvalue=1;</span></span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">default</span>: <span class=\"keyword\">break</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"><span class=\"comment\">/* USER CODE END 4 */</span></span><br></pre></td></tr></table></figure>\n<p>主函数内</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"comment\">/* USER CODE BEGIN 2 */</span></span><br><span class=\"line\"><span class=\"built_in\">HAL_TIM_Base_Start</span>(&amp;htim2);<span class=\"comment\">//开启TIM2用于计数</span></span><br><span class=\"line\"><span class=\"built_in\">HAL_TIM_Base_Start_IT</span>(&amp;htim6);<span class=\"comment\">//开启TIM6用于按键检测</span></span><br><span class=\"line\"><span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Timer counter founction test: \\n&quot;</span>);<span class=\"comment\">//串口起始提示</span></span><br><span class=\"line\"> <span class=\"comment\">/* USER CODE END 2 */</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"comment\">/* Infinite loop */</span></span><br><span class=\"line\"> <span class=\"comment\">/* USER CODE BEGIN WHILE */</span></span><br><span class=\"line\"> <span class=\"keyword\">while</span> (<span class=\"number\">1</span>)</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">   <span class=\"comment\">/* USER CODE END WHILE */</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"comment\">/* USER CODE BEGIN 3 */</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(keyvalue==<span class=\"number\">1</span>)<span class=\"comment\">//如果为按下状态</span></span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tkeyvalue=<span class=\"number\">0</span>;</span><br><span class=\"line\">\t\t<span class=\"built_in\">HAL_GPIO_WritePin</span>(GPIOA,GPIO_PIN_1,GPIO_PIN_SET);</span><br><span class=\"line\">\t\t<span class=\"built_in\">HAL_Delay</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">\t\t<span class=\"built_in\">HAL_GPIO_WritePin</span>(GPIOA,GPIO_PIN_1,GPIO_PIN_RESET);</span><br><span class=\"line\">\t\t<span class=\"built_in\">HAL_Delay</span>(<span class=\"number\">1</span>);<span class=\"comment\">//发出周期为2ms的脉冲</span></span><br><span class=\"line\">\t\tResult=__HAL_TIM_GET_COUNTER(&amp;htim2);<span class=\"comment\">//读取计数值</span></span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Counter:%d.\\n&quot;</span>,Result);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"comment\">/* USER CODE END 3 */</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"CUBEMX配置\"><a href=\"#CUBEMX配置\" class=\"headerlink\" title=\"CUBEMX配置\"></a>CUBEMX配置</h2><p>1.时钟配置外部晶振，主时钟为72MHz<br><img src=\"https://img-blog.csdnimg.cn/979c22c7e76f4ab78bc893bb547e198b.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_Q1NETiBA5Y2X5bGx56yR,size_40,color_FFFFFF,t_70,g_se,x_16\" alt=\"在这里插入图片描述\"><br><img src=\"https://img-blog.csdnimg.cn/34c3cc70065643e0a83680e530b4fa1f.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_Q1NETiBA5Y2X5bGx56yR,size_28,color_FFFFFF,t_70,g_se,x_16\" alt=\"在这里插入图片描述\"><br>2.GPIO：选择PA1输出，PE3输入<br><img src=\"https://img-blog.csdnimg.cn/99ee5bd1a11d457b882ae5e5351cf12c.png\" alt=\"在这里插入图片描述\"><br>3.TIM：<br>TIM2：Clock Source：外部触发<br><img src=\"https://img-blog.csdnimg.cn/dff3c1e441b548fd8fce92e0c69cc35f.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_Q1NETiBA5Y2X5bGx56yR,size_40,color_FFFFFF,t_70,g_se,x_16\" alt=\"在这里插入图片描述\"><br>这时PA0为你的触发引脚<br><img src=\"https://img-blog.csdnimg.cn/c4b66361f77d4f38a0683db19bedb4ce.png\" alt=\"在这里插入图片描述\"><br>TIM6：激活并生成10ms中断<br><img src=\"https://img-blog.csdnimg.cn/6eeb551aeaaf4abda7027fe83d121b43.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_Q1NETiBA5Y2X5bGx56yR,size_30,color_FFFFFF,t_70,g_se,x_16\" alt=\"在这里插入图片描述\"><br>4.usart设置<br><img src=\"https://img-blog.csdnimg.cn/a6749464d8264738a2744efc34c42a99.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_Q1NETiBA5Y2X5bGx56yR,size_40,color_FFFFFF,t_70,g_se,x_16\" alt=\"在这里插入图片描述\"></p>\n<p>5.Project的设置，<br><img src=\"https://img-blog.csdnimg.cn/e25a54d171e6456e9606191ea4a2796e.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_Q1NETiBA5Y2X5bGx56yR,size_28,color_FFFFFF,t_70,g_se,x_16\" alt=\"在这里插入图片描述\"><br>还有一个之前没注意，就是在Code Generator一栏中第一个方框里选择第二个：Copy only the necessary library files，要不一个工程就是百八十MB，占内存。</p>\n<p><img src=\"https://img-blog.csdnimg.cn/a29154c1ca2a4f3587b8d571a6a4f741.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_Q1NETiBA5Y2X5bGx56yR,size_34,color_FFFFFF,t_70,g_se,x_16\" alt=\"在这里插入图片描述\"><br>最后生成代码</p>\n","categories":[{"name":"基本功能食用","slug":"基本功能食用","count":10,"path":"api/categories/基本功能食用.json"}],"tags":[{"name":"STM32","slug":"STM32","count":10,"path":"api/tags/STM32.json"},{"name":"大一课程准备","slug":"大一课程准备","count":10,"path":"api/tags/大一课程准备.json"},{"name":"基本外设","slug":"基本外设","count":8,"path":"api/tags/基本外设.json"},{"name":"HAL库","slug":"HAL库","count":8,"path":"api/tags/HAL库.json"}]}